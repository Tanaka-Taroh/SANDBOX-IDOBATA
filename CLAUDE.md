# CLAUDE.md — 全プロジェクト共通ガイド（v2025-07-31）

---

## ⬇ **AI 運用 5 原則**（毎チャット冒頭に必ず貼り付ける）⬇
1. **開発の出発点は必ず「井戸端会議 (/idobata-init) ＋ TDD ＋ o3検索」の三位一体で行う**  
2. **リサーチは o3-mcp のみに限定し、実装中の疑問・エラーは即座に GeminiCLI / OpenAI Codex へ相談する**  
3. **自己判断で仕様変更・修正しない。仕様変更・修正の必要があると判断したら必ず井戸端会議で結論を得た後、ユーザーの最終承認を得る**  
4. **ユーザーが最終決定権を持ち、AI は補助に徹する。勝手な最適化・省略は禁止**  
5. **本原則を毎チャット冒頭に出力し、コンテキストに保持することを厳守する**

---

## 1．役割定義

| ロール         | 実体                            | 主な責務                                   |
|---------------|--------------------------------|-------------------------------------------|
| **実行者**     | ClaudeCode CLI                 | コード生成・テスト実行・タスク管理              |
| **助言者**     | Gemini CLI / OpenAI Codex      | 実装中の壁打ち・エラー解決・リファクタ助言       |
| **リサーチャ**   | o3-mcp                         | 文献・実装例・公式資料などの検索と要約提供       |
| **記憶者**     | Serena-mcp                     | 効率的なコンテキスト保持                      |

> **禁止事項**  
> • Claude 内蔵ブラウザ検索の直接使用  
> • 助言者・リサーチャを経由しない自己判断での修正・仕様変更  
> • 助言者によるコードの書き換え

---

## 2．開発フロー（3段階承認 → 実装）

```

\[idobata-init] → \[require-approve] → \[design-approve] → \[tasks-approve] → \[実装 (TDD+Mentor)] → \[postmortem]

```

| フェーズ                | コマンド                                | 生成物                                   | 承認者   |
|------------------------|----------------------------------------|----------------------------------------|---------|
| 井戸端会議開始           | `/idobata-init`                        | `.spec/steering/<draft>.md`             | ユーザー |
| **要件生成**            | `/spec-requirements <feature>`         | `.spec/specs/<feature>/requirements.md` | ユーザー |
| **設計生成**            | `/spec-design <feature>`               | `.spec/specs/<feature>/design.md`       | ユーザー |
| **タスク生成**           | `/spec-tasks <feature>`                | `.spec/specs/<feature>/tasks.md`        | ユーザー |
| 実装 (TDD+Mentor)      | `/mentor-help` / 自動呼出                | コード & テスト                           | —      |
| 振り返り                | `/postmortem`                          | `.spec/retros/<date>.md`              　 | —      |

*各生成フェーズは **「生成 → レビュー → ユーザー承認」** が完了しない限り次へ進めない。  
*全て承認された時点で初めて実装タスクを着手可能。  

### 2.1 井戸端会議フェーズ詳細

* **井戸端会議開始** `/idobata-init`  
  * ディレクトリ標準を構築後、ユーザー作成の"overview.md"に従い、俯瞰的視点からシステム概要を作成
* **要件フェーズ** `/spec-requirements`  
  * o3-mcp で調査した裏付けを含め、価値・受入基準を定義  
* **設計フェーズ** `/spec-design`  
  * 技術アーキテクチャ・データフロー・API などを記述  
* **タスクフェーズ** `/spec-tasks`  
  * TDD 単位に分割した実装タスクとテスト項目を列挙  
* 各フェーズ完了時、Claude は「**次フェーズへ進むにはユーザー承認が必要です**」と明示し、  
  ユーザーが **Approve / Request-changes** を返答するまで待機すること。

### 2.2 実装 (TDD)
* タスク開始時やエラー発生時に **`/mentor-help`** で助言者を呼び出し  
* エラー検知（`exit≠0`）で自動 **`/mentor-help`** と **`/idobata-search`**（o3）  
* テスト合格後にプルリク作成

---

## 3．コマンド チートシート

| コマンド | 説明 |
|----------|------|
| **`/idobata-init`**            | 井戸端会議を開始し、三ロールを召集 |
| **`/spec-requirements`**       | 要件ドラフト生成 |
| **`/spec-design`**             | 設計ドラフト生成（要件承認後） |
| **`/spec-tasks`**              | タスクドラフト生成（設計承認後） |
| **`/mentor-help`**             | 助言者（Gemini/Codex）に質問 |
| **`/idobata-search`**          | o3-mcp で追加リサーチ |
| **`/postmortem`**              | 振り返りテンプレート生成 |

---

## 4．外部 CLI 呼び出し例

| ツール | サンプルコマンド | 備考 |
|--------|-----------------|------|
| **Gemini CLI**   | `gemini -p "<質問文>"`   | `-p` はプロンプト引数 |
| **OpenAI Codex** | `codex exec "<質問文>"`  | 引数は`exec` |
| **o3-mcp**       | `/mcp__o3__o3-search` | `o3s` は o3-search-mcp ラッパー |
| **serena-mcp**   | `/mcp__serena__initial_instructions` | 大規模ファイルの読み込みは必ず最初に投げること |

---

## 5．ディレクトリ標準

```

CLAUDE-SANDBOX/
├── CLAUDE.md　　　　　　　　　#本マークダウン
└── PROJECT/
└── <プロジェクト名>/
├── .spec/
│   ├── overview\.md        # ★ プロジェクト概要（ユーザー作成）
│   ├── steering/          　# 井戸端会議ドラフト
│   ├── specs/
│   │   └── <feature>/
│   │       ├── requirements.md
│   │       ├── design.md
│   │       └── tasks.md
│   └── retros/            # 振り返り
├── .tasks/                # テスト & 実装タスク
├── .references/           # 参照資料
├── CLAUDE.local.md        # プロジェクト固有ルール (ユーザー作成)
└── .code/                 # 実装コード

```

---

## 6．禁止事項
1. コミット履歴の強制改変 (`git push --force`)  
2. ユーザー未承認でモデル設定・依存ライブラリを変更  
3. 5原則の削除・改変・貼付け忘れ  

---

_改訂は Pull Request 経由で行い、ユーザー承認を必須とする。_
```
